#include "../include/main.h"

t_log* logger;

int main(int argc, char** argv) {
	t_config* config;
	char* config_path;
	char* pseudo_path;
	int conexion_kernel;

	logger = log_create("Consola.log", "logger", true, LOG_LEVEL_TRACE);

	if (argc < 3) {
		log_error(logger, "Se necesitan mas argumentos para inicializar correctamente la consola");
		return EXIT_FAILURE;
	}

	saludar();

	strcpy(config_path, argv[1]);
	strcpy(pseudo_path, argv[2]);

	log_debug(logger, "config: %s", config_path);
	log_debug(logger, "pseudo: %s", pseudo_path);


	config = config_create(config_path);

	if (config == NULL) {
		log_error(logger, "No se pudo abrir el archivo de configuracion en ese path");
		return EXIT_FAILURE;
	}

	char* ip_kernel = config_get_string_value(config, "IP_KERNEL");
	char* puerto_kernel = config_get_string_value(config, "PUERTO_KERNEL");

	conexion_kernel = conect_to_kernel(ip_kernel, puerto_kernel);

	return liberar_memoria(config, conexion_kernel);
}

int liberar_memoria(t_config* config, int conexion_kernel) {
	liberar_conexion(conexion_kernel);
	log_destroy(logger);
	config_destroy(config);
	return EXIT_SUCCESS;
}

int conect_to_kernel(char* ip, char* puerto) {
	log_info(logger, "Iniciando conexion con el Kernel - Puerto: %s - IP: %s", ip, puerto);
	return crear_conexion(ip, puerto);
}


